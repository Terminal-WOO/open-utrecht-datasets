<!doctype html>
<html lang="nl">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Utrecht Open Data</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Arial,
                    sans-serif;
                background: #f5f5f5;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            header {
                background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
                color: white;
                padding: 40px 30px;
                border-radius: 12px;
                text-align: center;
                margin-bottom: 30px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }

            .info-banner {
                background: #e3f2fd;
                border-left: 4px solid #2196f3;
                padding: 15px 20px;
                border-radius: 8px;
                margin-bottom: 20px;
            }

            .info-banner a {
                color: #1976d2;
                font-weight: 600;
            }

            .search-box {
                background: white;
                padding: 25px;
                border-radius: 12px;
                margin-bottom: 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            input {
                width: calc(100% - 240px);
                padding: 14px 18px;
                font-size: 16px;
                border: 2px solid #ddd;
                border-radius: 8px;
                transition: border-color 0.3s;
            }

            input:focus {
                outline: none;
                border-color: #cc0000;
            }

            button {
                padding: 14px 28px;
                background: #cc0000;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 600;
                margin-left: 10px;
                transition: all 0.3s;
            }

            button:hover {
                background: #990000;
                transform: translateY(-1px);
            }

            #status {
                background: white;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                text-align: center;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            #results {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 20px;
                margin-bottom: 40px;
            }

            .dataset-card {
                background: white;
                padding: 24px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                transition: all 0.3s;
            }

            .dataset-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            }

            .dataset-title {
                font-size: 1.3em;
                font-weight: 700;
                color: #cc0000;
                margin-bottom: 10px;
            }

            .dataset-description {
                color: #666;
                line-height: 1.6;
                margin-bottom: 12px;
            }

            .dataset-meta {
                display: flex;
                gap: 15px;
                font-size: 0.9em;
                color: #999;
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 1000;
                overflow-y: auto;
                padding: 40px 20px;
            }

            .modal-content {
                background: white;
                max-width: 900px;
                width: 100%;
                border-radius: 12px;
                padding: 40px;
                position: relative;
                margin: auto;
            }

            .close-btn {
                position: absolute;
                top: 20px;
                right: 20px;
                font-size: 32px;
                color: #999;
                cursor: pointer;
                background: none;
                border: none;
                width: 40px;
                height: 40px;
                padding: 0;
                line-height: 1;
            }

            .close-btn:hover {
                color: #cc0000;
            }

            .details-title {
                color: #cc0000;
                font-size: 2em;
                margin-bottom: 10px;
                padding-right: 50px;
            }

            .download-item {
                background: #f9f9f9;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 15px;
                border-left: 5px solid #cc0000;
            }

            .download-format {
                font-weight: bold;
                color: #cc0000;
                font-size: 1.2em;
                text-transform: uppercase;
            }

            .download-link {
                display: inline-block;
                margin-top: 10px;
                padding: 10px 20px;
                background: #0066cc;
                color: white;
                text-decoration: none;
                border-radius: 6px;
                font-weight: 600;
                transition: all 0.3s;
            }

            .download-link:hover {
                background: #0052a3;
            }

            .loading {
                text-align: center;
                padding: 40px;
                color: #666;
            }

            @media (max-width: 768px) {
                input {
                    width: 100%;
                    margin-bottom: 10px;
                }

                button {
                    width: 100%;
                    margin-left: 0;
                    margin-bottom: 10px;
                }

                #results {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>üèõÔ∏è Utrecht Open Data</h1>
                <p>
                    Doorzoek en download open datasets van de gemeente Utrecht
                </p>
            </header>

            <div class="info-banner">
                üí° <strong>Wil je ook 10.000+ landelijke datasets?</strong>
                Download de volledige toolkit met MCP server en data.overheid.nl
                integratie op
                <a
                    href="https://github.com/Terminal-WOO/open-utrecht-datasets"
                    target="_blank"
                >
                    GitHub
                </a>
            </div>

            <div class="search-box">
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Zoek naar datasets (bijv. verkeer, parkeren, afval)..."
                />
                <button onclick="search()">üîç Zoeken</button>
                <button onclick="loadAll()">üìã Toon alle</button>
            </div>

            <div id="status">Datasets laden...</div>
            <div id="results"></div>
        </div>

        <div id="modal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal()">
                    &times;
                </button>
                <div id="modalContent"></div>
            </div>
        </div>

        <script>
            let allDatasets = [];

            function getAttr(obj, key) {
                return (
                    obj[`dct:${key}`] ||
                    obj[`dcat:${key}`] ||
                    obj[`foaf:${key}`] ||
                    obj[key] ||
                    null
                );
            }

            function escapeHtml(text) {
                if (!text) return "";
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            async function loadAll() {
                document.getElementById("status").textContent =
                    "Datasets laden...";
                document.getElementById("results").innerHTML = "";

                try {
                    // Use CORS proxy for GitHub Pages
                    const apiUrl = "https://api.allorigins.win/raw?url=https%3A%2F%2Fopen.utrecht.nl%2Fapi%2Fdatasets";
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(apiUrl)}`;

                    const response = await fetch(proxyUrl);
                    if (!response.ok)
                        throw new Error(`HTTP ${response.status}`);

                    const data = await response.json();
                    allDatasets = data.data || [];
                    document.getElementById("status").textContent =
                        `${allDatasets.length} datasets geladen`;
                    displayResults(allDatasets);
                } catch (error) {
                    document.getElementById("status").textContent =
                        "‚ùå Fout bij laden datasets";
                    console.error("Error:", error);
                }
            }

            function search() {
                const query = document
                    .getElementById("searchInput")
                    .value.toLowerCase();
                if (!query) {
                    loadAll();
                    return;
                }

                const filtered = allDatasets.filter((ds) => {
                    const attrs = ds.attributes || {};
                    const title = (getAttr(attrs, "title") || "").toLowerCase();
                    const desc = (
                        getAttr(attrs, "description") || ""
                    ).toLowerCase();
                    const id = (ds.id || "").toLowerCase();
                    return (
                        title.includes(query) ||
                        desc.includes(query) ||
                        id.includes(query)
                    );
                });

                document.getElementById("status").textContent =
                    `${filtered.length} datasets gevonden`;
                displayResults(filtered);
            }

            function displayResults(datasets) {
                const resultsDiv = document.getElementById("results");

                if (datasets.length === 0) {
                    resultsDiv.innerHTML =
                        '<div class="loading">Geen datasets gevonden</div>';
                    return;
                }

                resultsDiv.innerHTML = datasets
                    .map((dataset) => {
                        const attrs = dataset.attributes || {};
                        const title = escapeHtml(
                            getAttr(attrs, "title") || dataset.id,
                        );
                        const desc = escapeHtml(
                            getAttr(attrs, "description") || "",
                        );
                        const preview =
                            desc.length > 150
                                ? desc.substring(0, 150) + "..."
                                : desc;

                        return `
                        <div class="dataset-card" onclick='showDetails("${dataset.id}")'>
                            <div class="dataset-title">${title}</div>
                            <div class="dataset-description">${preview}</div>
                            <div class="dataset-meta">
                                <span>üì¶ ID: ${dataset.id}</span>
                            </div>
                        </div>
                    `;
                    })
                    .join("");
            }

            async function showDetails(datasetId) {
                document.getElementById("modal").style.display = "flex";
                document.getElementById("modalContent").innerHTML =
                    '<div class="loading">Details laden...</div>';

                try {
                    const response = await fetch(
                        `https://api.allorigins.win/raw?url=https%3A%2F%2Fopen.utrecht.nl%2Fapi%2Fdatasets/${datasetId}`,
                    );
                    if (!response.ok)
                        throw new Error(`HTTP ${response.status}`);

                    const data = await response.json();
                    const dataset = data.data || data;

                    // Get distributions
                    const distResponse = await fetch(
                        `https://api.allorigins.win/raw?url=https%3A%2F%2Fopen.utrecht.nl%2Fapi%2Fdatasets/${datasetId}/distributions`,
                    );
                    const distData = await distResponse.json();
                    const distributions = distData.data || [];

                    displayDetailsModal(dataset, distributions);
                } catch (error) {
                    document.getElementById("modalContent").innerHTML =
                        '<div class="loading">‚ùå Fout bij ophalen details</div>';
                    console.error("Error:", error);
                }
            }

            function displayDetailsModal(dataset, distributions) {
                const attrs = dataset.attributes || {};
                const title = escapeHtml(getAttr(attrs, "title") || dataset.id);
                const desc = escapeHtml(
                    getAttr(attrs, "description") || "Geen beschrijving",
                );

                let html = `
                    <div class="details-title">${title}</div>
                    <p style="margin-bottom: 20px;">${desc}</p>
                `;

                if (distributions.length > 0) {
                    html +=
                        '<h3 style="margin-bottom: 15px;">üì¶ Downloads</h3>';

                    distributions.forEach((dist) => {
                        const dAttrs = dist.attributes || {};
                        let formatRaw = getAttr(dAttrs, "format") || "DOWNLOAD";
                        let format = formatRaw;
                        if (formatRaw.includes("/")) {
                            const parts = formatRaw.split("/");
                            format = parts[parts.length - 1].toUpperCase();
                        }

                        const accessURL = getAttr(dAttrs, "accessURL");
                        const title = getAttr(dAttrs, "title") || format;

                        html += `
                            <div class="download-item">
                                <div class="download-format">${format}</div>
                                <div>${escapeHtml(title)}</div>
                                ${
                                    accessURL
                                        ? `<a href="${escapeHtml(accessURL)}" class="download-link" target="_blank" onclick="event.stopPropagation()">‚¨áÔ∏è Download</a>`
                                        : ""
                                }
                            </div>
                        `;
                    });
                } else {
                    html +=
                        '<p style="color: #999;">Geen downloads beschikbaar</p>';
                }

                document.getElementById("modalContent").innerHTML = html;
            }

            function closeModal() {
                document.getElementById("modal").style.display = "none";
            }

            document
                .getElementById("searchInput")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter") search();
                });

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeModal();
            });

            // Auto-load
            loadAll();
        </script>
    </body>
</html>
