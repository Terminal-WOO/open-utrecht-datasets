<!doctype html>
<html lang="nl">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Utrecht Open Data</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Arial,
                    sans-serif;
                background: #f5f5f5;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            header {
                background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
                color: white;
                padding: 40px 30px;
                border-radius: 12px;
                text-align: center;
                margin-bottom: 30px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }

            .search-box {
                background: white;
                padding: 25px;
                border-radius: 12px;
                margin-bottom: 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            input {
                width: calc(100% - 240px);
                padding: 14px 18px;
                font-size: 16px;
                border: 2px solid #ddd;
                border-radius: 8px;
                transition: border-color 0.3s;
            }

            input:focus {
                outline: none;
                border-color: #cc0000;
            }

            button {
                padding: 14px 28px;
                background: #cc0000;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 600;
                margin-left: 10px;
                transition: all 0.3s;
            }

            button:hover {
                background: #990000;
                transform: translateY(-1px);
            }

            #status {
                background: white;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                text-align: center;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            #results {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 20px;
                margin-bottom: 40px;
            }

            .dataset-card {
                background: white;
                padding: 24px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                transition: all 0.3s;
                border: 2px solid transparent;
            }

            .dataset-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
                border-color: #cc0000;
            }

            .dataset-card h3 {
                color: #cc0000;
                margin-bottom: 12px;
                font-size: 1.3em;
            }

            .dataset-card p {
                color: #666;
                line-height: 1.5;
                margin-bottom: 12px;
            }

            .dataset-id {
                font-size: 13px;
                color: #999;
                font-family: "Courier New", monospace;
            }

            /* Modal */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.75);
                z-index: 1000;
                overflow-y: auto;
                padding: 40px 20px;
            }

            .modal.show {
                display: flex;
                align-items: flex-start;
                justify-content: center;
            }

            .modal-content {
                background: white;
                max-width: 900px;
                width: 100%;
                border-radius: 12px;
                padding: 40px;
                position: relative;
                margin: auto;
            }

            .close-btn {
                position: absolute;
                top: 20px;
                right: 20px;
                font-size: 32px;
                color: #999;
                cursor: pointer;
                background: none;
                border: none;
                width: 40px;
                height: 40px;
                padding: 0;
                line-height: 1;
            }

            .close-btn:hover {
                color: #cc0000;
            }

            .details-title {
                color: #cc0000;
                font-size: 2em;
                margin-bottom: 10px;
                padding-right: 50px;
            }

            .details-id {
                font-family: "Courier New", monospace;
                color: #999;
                font-size: 14px;
                margin-bottom: 25px;
            }

            .meta-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                background: #f9f9f9;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 30px;
            }

            .meta-item strong {
                display: block;
                color: #333;
                margin-bottom: 5px;
            }

            .meta-item {
                color: #666;
            }

            .section {
                margin-bottom: 30px;
            }

            .section h3 {
                color: #333;
                font-size: 1.4em;
                margin-bottom: 15px;
            }

            .section p {
                color: #666;
                line-height: 1.7;
            }

            .download-item {
                background: #f9f9f9;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 15px;
                border-left: 5px solid #cc0000;
            }

            .download-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }

            .download-format {
                font-weight: bold;
                color: #cc0000;
                font-size: 1.2em;
                text-transform: uppercase;
            }

            .download-title {
                color: #333;
                margin-bottom: 8px;
            }

            .download-link {
                display: inline-block;
                margin-top: 10px;
                padding: 10px 20px;
                background: #0066cc;
                color: white;
                text-decoration: none;
                border-radius: 6px;
                font-weight: 600;
                transition: all 0.3s;
            }

            .download-link:hover {
                background: #0052a3;
                transform: translateX(4px);
            }

            .loading {
                text-align: center;
                padding: 40px;
                color: #666;
            }
            .woo-section {
                background: #fff8e1;
                border-left: 5px solid #ff9800;
                padding: 20px;
                border-radius: 8px;
                margin-top: 20px;
            }
            .woo-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 15px;
            }
            .woo-header h3 {
                margin: 0;
                color: #e65100;
            }
            .woo-score {
                background: #ff9800;
                color: white;
                padding: 5px 15px;
                border-radius: 20px;
                font-weight: bold;
                font-size: 0.9em;
            }
            .woo-topics {
                margin: 15px 0;
            }
            .woo-topic-tag {
                display: inline-block;
                background: #fff;
                border: 2px solid #ff9800;
                color: #e65100;
                padding: 5px 12px;
                border-radius: 15px;
                margin: 5px 5px 5px 0;
                font-size: 0.85em;
                font-weight: 600;
            }
            .woo-categories {
                margin: 15px 0;
                padding: 15px;
                background: white;
                border-radius: 6px;
            }
            .woo-category-item {
                padding: 10px;
                border-left: 3px solid #ff9800;
                margin: 10px 0;
                background: #fafafa;
            }
            .woo-link {
                display: inline-block;
                margin-top: 15px;
                padding: 10px 20px;
                background: #ff9800;
                color: white;
                text-decoration: none;
                border-radius: 6px;
                font-weight: 600;
                transition: all 0.3s;
            }
            .woo-link:hover {
                background: #e68900;
                transform: translateX(4px);
            }
            .woo-loading {
                text-align: center;
                padding: 20px;
                color: #666;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>üèõÔ∏è Utrecht Open Data</h1>
                <p>
                    Doorzoek en download open datasets van de gemeente Utrecht
                </p>
            </header>

            <div class="search-box">
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Zoek naar datasets (bijv. verkeer, parkeren, afval)..."
                />
                <button onclick="search()">üîç Zoeken</button>
                <button onclick="loadAll()">üìã Toon alle</button>
            </div>

            <div id="status">Datasets laden...</div>
            <div id="results"></div>
        </div>

        <div id="modal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal()">
                    &times;
                </button>
                <div id="modalContent"></div>
            </div>
        </div>

        <script>
            let allDatasets = [];

            // Helper functie voor namespaced attributen
            function getAttr(obj, key) {
                return (
                    obj[`dct:${key}`] ||
                    obj[`dcat:${key}`] ||
                    obj[`foaf:${key}`] ||
                    obj[key] ||
                    null
                );
            }

            function escapeHtml(text) {
                if (!text) return "";
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            async function loadAll() {
                document.getElementById("status").textContent =
                    "Datasets laden...";
                document.getElementById("results").innerHTML = "";

                try {
                    const response = await fetch("/api/datasets");
                    if (!response.ok)
                        throw new Error(`HTTP ${response.status}`);

                    const data = await response.json();
                    allDatasets = data.data || [];

                    document.getElementById("status").textContent =
                        `${allDatasets.length} datasets geladen`;
                    displayResults(allDatasets);
                } catch (error) {
                    document.getElementById("status").textContent =
                        `Fout: ${error.message}`;
                    console.error(error);
                }
            }

            function search() {
                const query = document
                    .getElementById("searchInput")
                    .value.trim()
                    .toLowerCase();

                if (!query) {
                    loadAll();
                    return;
                }

                const filtered = allDatasets.filter((ds) => {
                    const attrs = ds.attributes || {};
                    const title = (getAttr(attrs, "title") || "").toLowerCase();
                    const desc = (
                        getAttr(attrs, "description") || ""
                    ).toLowerCase();
                    const id = (ds.id || "").toLowerCase();
                    return (
                        title.includes(query) ||
                        desc.includes(query) ||
                        id.includes(query)
                    );
                });

                document.getElementById("status").textContent =
                    `${filtered.length} resultaten voor "${query}"`;
                displayResults(filtered);
            }

            function displayResults(datasets) {
                const html = datasets
                    .map((ds) => {
                        const attrs = ds.attributes || {};
                        const title =
                            getAttr(attrs, "title") || ds.id || "Geen titel";
                        const desc =
                            getAttr(attrs, "description") ||
                            "Geen beschrijving";

                        return `
                    <div class="dataset-card" onclick="showDetails('${escapeHtml(ds.id)}')">
                        <h3>${escapeHtml(title)}</h3>
                        <p>${escapeHtml(desc.substring(0, 180))}${desc.length > 180 ? "..." : ""}</p>
                        <div class="dataset-id">üìÅ ${escapeHtml(ds.id)}</div>
                    </div>
                `;
                    })
                    .join("");

                document.getElementById("results").innerHTML =
                    html || "<p>Geen datasets gevonden</p>";
            }

            async function showDetails(datasetId) {
                const modal = document.getElementById("modal");
                const content = document.getElementById("modalContent");

                modal.classList.add("show");
                content.innerHTML =
                    '<div class="loading">‚è≥ Details laden...</div>';

                try {
                    // Dataset ophalen
                    const dsResp = await fetch(`/api/datasets/${datasetId}`);
                    if (!dsResp.ok) throw new Error("Dataset niet gevonden");
                    const dsData = await dsResp.json();
                    const dataset = dsData.data || dsData;

                    // Distributies ophalen
                    let distributions = [];
                    try {
                        const distResp = await fetch(
                            `/api/datasets/${datasetId}/distributions`,
                        );
                        if (distResp.ok) {
                            const distData = await distResp.json();
                            distributions = distData.data || [];
                        }
                    } catch (e) {
                        console.warn("Geen distributies");
                    }

                    renderDetails(dataset, distributions);
                } catch (error) {
                    content.innerHTML = `<div class="loading">‚ùå Fout: ${error.message}</div>`;
                }
            }

            function renderDetails(dataset, distributions) {
                const attrs = dataset.attributes || {};
                const title = getAttr(attrs, "title") || dataset.id;
                const desc =
                    getAttr(attrs, "description") || "Geen beschrijving";
                const modified = getAttr(attrs, "modified");
                const issued = getAttr(attrs, "issued");

                let publisher = getAttr(attrs, "publisher");
                if (
                    publisher &&
                    typeof publisher === "string" &&
                    publisher.includes("/")
                ) {
                    publisher = publisher.split("/").pop().replace(/_/g, " ");
                }

                let downloadsHtml =
                    "<p>Geen downloads beschikbaar voor deze dataset.</p>";

                if (distributions.length > 0) {
                    downloadsHtml = distributions
                        .map((dist) => {
                            const dAttrs = dist.attributes || {};

                            // Haal format op - kan een URI zijn zoals "http://.../CSV"
                            let formatRaw =
                                getAttr(dAttrs, "format") || "DOWNLOAD";
                            let format = formatRaw;
                            if (formatRaw.includes("/")) {
                                const parts = formatRaw.split("/");
                                format = parts[parts.length - 1].toUpperCase();
                            }

                            const distTitle =
                                getAttr(dAttrs, "title") ||
                                `${format} Download`;
                            const distDesc =
                                getAttr(dAttrs, "description") || "";
                            const accessURL = getAttr(dAttrs, "accessURL");
                            const downloadURL =
                                getAttr(dAttrs, "downloadURL") || accessURL;

                            return `
                        <div class="download-item">
                            <div class="download-header">
                                <div class="download-format">üìÑ ${escapeHtml(format)}</div>
                            </div>
                            <div class="download-title">${escapeHtml(distTitle)}</div>
                            ${distDesc ? `<p style="font-size: 14px; color: #666; margin-top: 5px;">${escapeHtml(distDesc)}</p>` : ""}
                            ${
                                downloadURL
                                    ? `
                                <a href="${escapeHtml(downloadURL)}" target="_blank" class="download-link">
                                    ‚¨áÔ∏è Download ${escapeHtml(format)}
                                </a>
                            `
                                    : '<p style="color: #999; margin-top: 10px;">Geen download link beschikbaar</p>'
                            }
                        </div>
                    `;
                        })
                        .join("");
                }

                const html = `
                <h2 class="details-title">${escapeHtml(title)}</h2>
                <div class="details-id">Dataset ID: ${escapeHtml(dataset.id)}</div>

                <div class="meta-grid">
                    ${
                        publisher
                            ? `
                        <div class="meta-item">
                            <strong>üèõÔ∏è Uitgever</strong>
                            ${escapeHtml(publisher)}
                        </div>
                    `
                            : ""
                    }
                    ${
                        modified
                            ? `
                        <div class="meta-item">
                            <strong>üîÑ Laatst gewijzigd</strong>
                            ${new Date(modified).toLocaleDateString("nl-NL")}
                        </div>
                    `
                            : ""
                    }
                    ${
                        issued
                            ? `
                        <div class="meta-item">
                            <strong>üìÖ Gepubliceerd</strong>
                            ${new Date(issued).toLocaleDateString("nl-NL")}
                        </div>
                    `
                            : ""
                    }
                </div>

                <div class="section">
                    <h3>üìñ Beschrijving</h3>
                    <p>${escapeHtml(desc)}</p>
                </div>

                <div class="section">
                    <h3>‚¨áÔ∏è Downloads</h3>
                    ${downloadsHtml}
                </div>
                <div class="section woo-section">
                    <div class="woo-header">
                        <h3>üîó Woo Koppeling</h3>
                    </div>
                    <div id="wooAnalysis-${escapeHtml(dataset.id)}" class="woo-loading">
                        ‚è≥ Woo-analyse laden...
                    </div>
                </div>
            `;

                document.getElementById("modalContent").innerHTML = html;

                // Load Woo analysis asynchronously
                loadWooAnalysis(dataset.id);
            }

            async function loadWooAnalysis(datasetId) {
                try {
                    const response = await fetch(`/woo/analyze/${datasetId}`);
                    const analysis = await response.json();

                    let html = "";

                    if (analysis.error) {
                        html = `<p style="color: #999;">‚ùå Fout bij Woo-analyse: ${escapeHtml(analysis.error)}</p>`;
                    } else {
                        // Topics
                        if (analysis.topics && analysis.topics.length > 0) {
                            html +=
                                '<div class="woo-topics"><strong>üìå Ge√Ødentificeerde onderwerpen:</strong><br>';
                            analysis.topics.forEach((topic) => {
                                html += `<span class="woo-topic-tag">${escapeHtml(topic)}</span>`;
                            });
                            html += "</div>";
                        }

                        // Categories
                        if (
                            analysis.categories &&
                            Object.keys(analysis.categories).length > 0
                        ) {
                            html +=
                                '<div class="woo-categories"><strong>‚úÖ Relevante Woo-categorie√´n:</strong>';
                            for (const [catId, catInfo] of Object.entries(
                                analysis.categories,
                            )) {
                                html += `
                                <div class="woo-category-item">
                                    <strong>[${escapeHtml(catId)}] ${escapeHtml(catInfo.name)}</strong><br>
                                    <span style="color: #666; font-size: 0.9em;">‚Üí ${escapeHtml(catInfo.reason)}</span>
                                </div>
                            `;
                            }
                            html += "</div>";
                        } else {
                            html +=
                                '<p style="color: #666; margin: 15px 0;">‚ÑπÔ∏è Geen directe Woo-categorie√´n ge√Ødentificeerd voor deze dataset.</p>';
                        }

                        // Link to Woo-index
                        html += `
                        <a href="https://organisaties.overheid.nl/woo/nl.oorg.gemutrecht_gemeente"
                           target="_blank"
                           class="woo-link">
                            üîç Bekijk Woo-documenten Utrecht
                        </a>
                    `;

                        // Keywords for search
                        if (analysis.keywords && analysis.keywords.length > 0) {
                            html += `
                            <p style="margin-top: 15px; font-size: 0.85em; color: #666;">
                                <strong>üí° Tip:</strong> Zoek op de Woo-index met termen als:
                                ${analysis.keywords
                                    .slice(0, 5)
                                    .map((k) => `"${escapeHtml(k)}"`)
                                    .join(", ")}
                            </p>
                        `;
                        }
                    }

                    document.getElementById(
                        `wooAnalysis-${datasetId}`,
                    ).innerHTML = html;
                } catch (error) {
                    document.getElementById(
                        `wooAnalysis-${datasetId}`,
                    ).innerHTML =
                        `<p style="color: #999;">‚ùå Kon Woo-analyse niet laden</p>`;
                    console.error("Woo analysis error:", error);
                }
            }

            function closeModal() {
                document.getElementById("modal").classList.remove("show");
            }

            // Event listeners
            document
                .getElementById("searchInput")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter") search();
                });

            document.getElementById("modal").addEventListener("click", (e) => {
                if (e.target.id === "modal") closeModal();
            });

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeModal();
            });

            // Auto-load
            loadAll();
        </script>
    </body>
</html>
