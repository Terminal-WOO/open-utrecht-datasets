<!doctype html>
<html lang="nl">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Utrecht Open Data</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Arial,
                    sans-serif;
                background: #f5f5f5;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            header {
                background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
                color: white;
                padding: 40px 30px;
                border-radius: 12px;
                text-align: center;
                margin-bottom: 30px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }

            .search-box {
                background: white;
                padding: 25px;
                border-radius: 12px;
                margin-bottom: 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            input {
                width: calc(100% - 240px);
                padding: 14px 18px;
                font-size: 16px;
                border: 2px solid #ddd;
                border-radius: 8px;
                transition: border-color 0.3s;
            }

            input:focus {
                outline: none;
                border-color: #cc0000;
            }

            button {
                padding: 14px 28px;
                background: #cc0000;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 600;
                margin-left: 10px;
                transition: all 0.3s;
            }

            button:hover {
                background: #990000;
                transform: translateY(-1px);
            }

            #status {
                background: white;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                text-align: center;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            #results {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 20px;
                margin-bottom: 40px;
            }

            .dataset-card {
                background: white;
                padding: 24px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                transition: all 0.3s;
                border: 2px solid transparent;
            }

            .dataset-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
                border-color: #cc0000;
            }

            .dataset-card h3 {
                color: #cc0000;
                margin-bottom: 12px;
                font-size: 1.3em;
            }

            .dataset-card p {
                color: #666;
                line-height: 1.5;
                margin-bottom: 12px;
            }

            .dataset-id {
                font-size: 13px;
                color: #999;
                font-family: "Courier New", monospace;
            }

            /* Modal */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.75);
                z-index: 1000;
                overflow-y: auto;
                padding: 40px 20px;
            }

            .modal.show {
                display: flex;
                align-items: flex-start;
                justify-content: center;
            }

            .modal-content {
                background: white;
                max-width: 900px;
                width: 100%;
                border-radius: 12px;
                padding: 40px;
                position: relative;
                margin: auto;
            }

            .close-btn {
                position: absolute;
                top: 20px;
                right: 20px;
                font-size: 32px;
                color: #999;
                cursor: pointer;
                background: none;
                border: none;
                width: 40px;
                height: 40px;
                padding: 0;
                line-height: 1;
            }

            .close-btn:hover {
                color: #cc0000;
            }

            .details-title {
                color: #cc0000;
                font-size: 2em;
                margin-bottom: 10px;
                padding-right: 50px;
            }

            .details-id {
                font-family: "Courier New", monospace;
                color: #999;
                font-size: 14px;
                margin-bottom: 25px;
            }

            .meta-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                background: #f9f9f9;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 30px;
            }

            .meta-item strong {
                display: block;
                color: #333;
                margin-bottom: 5px;
            }

            .meta-item {
                color: #666;
            }

            .section {
                margin-bottom: 30px;
            }

            .section h3 {
                color: #333;
                font-size: 1.4em;
                margin-bottom: 15px;
            }

            .section p {
                color: #666;
                line-height: 1.7;
            }

            .download-item {
                background: #f9f9f9;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 15px;
                border-left: 5px solid #cc0000;
            }

            .download-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }

            .download-format {
                font-weight: bold;
                color: #cc0000;
                font-size: 1.2em;
                text-transform: uppercase;
            }

            .download-title {
                color: #333;
                margin-bottom: 8px;
            }

            .download-link {
                display: inline-block;
                margin-top: 10px;
                padding: 10px 20px;
                background: #0066cc;
                color: white;
                text-decoration: none;
                border-radius: 6px;
                font-weight: 600;
                transition: all 0.3s;
            }

            .download-link:hover {
                background: #0052a3;
                transform: translateX(4px);
            }

            .loading {
                text-align: center;
                padding: 40px;
                color: #666;
            }
            .woo-section {
                background: #fff8e1;
                border-left: 5px solid #ff9800;
                padding: 20px;
                border-radius: 8px;
                margin-top: 20px;
            }
            .woo-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 15px;
            }
            .woo-header h3 {
                margin: 0;
                color: #e65100;
            }
            .woo-score {
                background: #ff9800;
                color: white;
                padding: 5px 15px;
                border-radius: 20px;
                font-weight: bold;
                font-size: 0.9em;
            }
            .woo-topics {
                margin: 15px 0;
            }
            .woo-topic-tag {
                display: inline-block;
                background: #fff;
                border: 2px solid #ff9800;
                color: #e65100;
                padding: 5px 12px;
                border-radius: 15px;
                margin: 5px 5px 5px 0;
                font-size: 0.85em;
                font-weight: 600;
            }
            .woo-categories {
                margin: 15px 0;
                padding: 15px;
                background: white;
                border-radius: 6px;
            }
            .woo-category-item {
                padding: 10px;
                border-left: 3px solid #ff9800;
                margin: 10px 0;
                background: #fafafa;
            }
            .woo-link {
                display: inline-block;
                margin-top: 15px;
                padding: 10px 20px;
                background: #ff9800;
                color: white;
                text-decoration: none;
                border-radius: 6px;
                font-weight: 600;
                transition: all 0.3s;
            }
            .woo-link:hover {
                background: #e68900;
                transform: translateX(4px);
            }
            .woo-loading {
                text-align: center;
                padding: 20px;
                color: #666;
            }

            /* Tabs styling */
            .tabs {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                background: white;
                padding: 10px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .tab {
                flex: 1;
                padding: 15px 25px;
                background: #f5f5f5;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: 600;
                transition: all 0.3s;
                color: #666;
            }

            .tab:hover {
                background: #e0e0e0;
            }

            .tab.active {
                background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
                color: white;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .org-filter {
                width: 250px;
                padding: 14px 18px;
                font-size: 16px;
                border: 2px solid #ddd;
                border-radius: 8px;
                margin-left: 10px;
                background: white;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>üèõÔ∏è Open Data Nederland</h1>
                <p>
                    Doorzoek en download open datasets van Utrecht √©n heel
                    Nederland
                </p>
            </header>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('utrecht')">
                    üèõÔ∏è Utrecht Open Data
                </button>
                <button class="tab" onclick="switchTab('overheid')">
                    üá≥üá± Data.overheid.nl
                </button>
            </div>

            <!-- Utrecht Tab -->
            <div id="utrecht-tab" class="tab-content active">
                <div class="search-box">
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Zoek Utrecht datasets (bijv. verkeer, parkeren, afval)..."
                    />
                    <button onclick="search()">üîç Zoeken</button>
                    <button onclick="loadAll()">üìã Toon alle</button>
                </div>
            </div>

            <!-- Data.overheid.nl Tab -->
            <div id="overheid-tab" class="tab-content">
                <div class="search-box">
                    <input
                        type="text"
                        id="overheidSearchInput"
                        placeholder="Zoek landelijke datasets (bijv. klimaat, CBS, energie)..."
                    />
                    <select id="orgFilter" class="org-filter">
                        <option value="">Alle organisaties</option>
                    </select>
                    <button onclick="searchOverheid()">üîç Zoeken</button>
                    <button onclick="loadOrganizations()">
                        üèõÔ∏è Organisaties
                    </button>
                </div>
            </div>

            <div id="status">Datasets laden...</div>
            <div id="results"></div>
        </div>

        <div id="modal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal()">
                    &times;
                </button>
                <div id="modalContent"></div>
            </div>
        </div>

        <script>
            let allDatasets = [];
            let currentTab = "utrecht";
            let allOrganizations = [];

            // Tab switching
            function switchTab(tab) {
                currentTab = tab;

                // Update tab buttons
                document
                    .querySelectorAll(".tab")
                    .forEach((t) => t.classList.remove("active"));
                event.target.classList.add("active");

                // Update tab content
                document
                    .querySelectorAll(".tab-content")
                    .forEach((tc) => tc.classList.remove("active"));
                document.getElementById(`${tab}-tab`).classList.add("active");

                // Clear results
                document.getElementById("results").innerHTML = "";
                document.getElementById("status").textContent =
                    tab === "utrecht"
                        ? "Klaar om te zoeken..."
                        : "Klaar om landelijke datasets te zoeken...";
            }

            // Helper functie voor namespaced attributen
            function getAttr(obj, key) {
                return (
                    obj[`dct:${key}`] ||
                    obj[`dcat:${key}`] ||
                    obj[`foaf:${key}`] ||
                    obj[key] ||
                    null
                );
            }

            function escapeHtml(text) {
                if (!text) return "";
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            async function loadAll() {
                document.getElementById("status").textContent =
                    "Datasets laden...";
                document.getElementById("results").innerHTML = "";

                try {
                    // Bepaal API base URL
                    const isLocal =
                        window.location.hostname === "localhost" ||
                        window.location.hostname === "127.0.0.1";

                    let apiUrl;
                    if (isLocal) {
                        // Lokaal: gebruik live API via proxy
                        apiUrl = "/api/datasets";
                    } else {
                        // GitHub Pages: gebruik statische datasets.json
                        apiUrl = "./datasets.json";
                    }

                    const response = await fetch(apiUrl);
                    if (!response.ok)
                        throw new Error(`HTTP ${response.status}`);

                    const data = await response.json();
                    allDatasets = data.data || [];

                    document.getElementById("status").textContent =
                        `${allDatasets.length} datasets geladen`;
                    displayResults(allDatasets);
                } catch (error) {
                    document.getElementById("status").textContent =
                        `Fout: ${error.message}`;
                    console.error(error);
                }
            }

            function search() {
                const query = document
                    .getElementById("searchInput")
                    .value.trim()
                    .toLowerCase();

                if (!query) {
                    loadAll();
                    return;
                }

                const filtered = allDatasets.filter((ds) => {
                    const attrs = ds.attributes || {};
                    const title = (getAttr(attrs, "title") || "").toLowerCase();
                    const desc = (
                        getAttr(attrs, "description") || ""
                    ).toLowerCase();
                    const id = (ds.id || "").toLowerCase();
                    return (
                        title.includes(query) ||
                        desc.includes(query) ||
                        id.includes(query)
                    );
                });

                document.getElementById("status").textContent =
                    `${filtered.length} resultaten voor "${query}"`;
                displayResults(filtered);
            }

            function displayResults(datasets) {
                const html = datasets
                    .map((ds) => {
                        const attrs = ds.attributes || {};
                        const title =
                            getAttr(attrs, "title") || ds.id || "Geen titel";
                        const desc =
                            getAttr(attrs, "description") ||
                            "Geen beschrijving";

                        return `
                    <div class="dataset-card" onclick="showDetails('${escapeHtml(ds.id)}')">
                        <h3>${escapeHtml(title)}</h3>
                        <p>${escapeHtml(desc.substring(0, 180))}${desc.length > 180 ? "..." : ""}</p>
                        <div class="dataset-id">üìÅ ${escapeHtml(ds.id)}</div>
                    </div>
                `;
                    })
                    .join("");

                document.getElementById("results").innerHTML =
                    html || "<p>Geen datasets gevonden</p>";
            }

            // Cache voor dataset details
            const detailsCache = new Map();
            const CACHE_DURATION = 5 * 60 * 1000; // 5 minuten

            async function showDetails(datasetId) {
                const startTime = performance.now();
                const modal = document.getElementById("modal");
                const content = document.getElementById("modalContent");

                modal.classList.add("show");
                content.innerHTML =
                    '<div class="loading">‚è≥ Details laden...</div>';

                console.log(
                    `Modal open: ${(performance.now() - startTime).toFixed(2)}ms`,
                );

                try {
                    // Check cache eerst
                    const cached = detailsCache.get(datasetId);
                    if (
                        cached &&
                        Date.now() - cached.timestamp < CACHE_DURATION
                    ) {
                        renderDetails(cached.dataset, cached.distributions);
                        return;
                    }

                    const fetchStart = performance.now();
                    // Bepaal of we lokaal draaien of op GitHub Pages
                    const isLocal =
                        window.location.hostname === "localhost" ||
                        window.location.hostname === "127.0.0.1";

                    let datasetUrl, distUrl;
                    if (isLocal) {
                        datasetUrl = `/api/datasets/${datasetId}`;
                        distUrl = `/api/datasets/${datasetId}/distributions`;
                    } else {
                        // GitHub Pages: gebruik AllOrigins CORS proxy voor details
                        datasetUrl =
                            "https://api.allorigins.win/get?url=" +
                            encodeURIComponent(
                                `https://open.utrecht.nl/api/datasets/${datasetId}`,
                            );
                        distUrl =
                            "https://api.allorigins.win/get?url=" +
                            encodeURIComponent(
                                `https://open.utrecht.nl/api/datasets/${datasetId}/distributions`,
                            );
                    }

                    // Parallel ophalen van dataset en distributies
                    const [dsResp, distResp] = await Promise.all([
                        fetch(datasetUrl),
                        fetch(distUrl).catch(() => null),
                    ]);

                    console.log(
                        `API fetch: ${(performance.now() - fetchStart).toFixed(2)}ms`,
                    );

                    if (!dsResp.ok) throw new Error("Dataset niet gevonden");

                    let dsData, distData;
                    if (isLocal) {
                        // Lokaal: directe JSON response
                        [dsData, distData] = await Promise.all([
                            dsResp.json(),
                            distResp?.ok
                                ? distResp.json()
                                : Promise.resolve({ data: [] }),
                        ]);
                    } else {
                        // GitHub Pages: AllOrigins wraps response in .contents
                        const [dsWrapped, distWrapped] = await Promise.all([
                            dsResp.json(),
                            distResp?.ok
                                ? distResp.json()
                                : Promise.resolve({ contents: '{"data":[]}' }),
                        ]);
                        dsData = JSON.parse(dsWrapped.contents);
                        distData = JSON.parse(distWrapped.contents);
                    }

                    const dataset = dsData.data || dsData;
                    const distributions = distData.data || [];

                    // Sla op in cache
                    detailsCache.set(datasetId, {
                        dataset,
                        distributions,
                        timestamp: Date.now(),
                    });

                    renderDetails(dataset, distributions);
                } catch (error) {
                    content.innerHTML = `<div class="loading">‚ùå Fout: ${error.message}</div>`;
                }
            }

            function renderDetails(dataset, distributions) {
                const attrs = dataset.attributes || {};
                const title = getAttr(attrs, "title") || dataset.id;
                const desc =
                    getAttr(attrs, "description") || "Geen beschrijving";
                const modified = getAttr(attrs, "modified");
                const issued = getAttr(attrs, "issued");

                let publisher = getAttr(attrs, "publisher");
                if (
                    publisher &&
                    typeof publisher === "string" &&
                    publisher.includes("/")
                ) {
                    publisher = publisher.split("/").pop().replace(/_/g, " ");
                }

                let downloadsHtml =
                    "<p>Geen downloads beschikbaar voor deze dataset.</p>";

                if (distributions.length > 0) {
                    downloadsHtml = distributions
                        .map((dist) => {
                            const dAttrs = dist.attributes || {};

                            // Haal format op - kan een URI zijn zoals "http://.../CSV"
                            let formatRaw =
                                getAttr(dAttrs, "format") || "DOWNLOAD";
                            let format = formatRaw;
                            if (formatRaw.includes("/")) {
                                const parts = formatRaw.split("/");
                                format = parts[parts.length - 1].toUpperCase();
                            }

                            const distTitle =
                                getAttr(dAttrs, "title") ||
                                `${format} Download`;
                            const distDesc =
                                getAttr(dAttrs, "description") || "";
                            const accessURL = getAttr(dAttrs, "accessURL");
                            const downloadURL =
                                getAttr(dAttrs, "downloadURL") || accessURL;

                            return `
                        <div class="download-item">
                            <div class="download-header">
                                <div class="download-format">üìÑ ${escapeHtml(format)}</div>
                            </div>
                            <div class="download-title">${escapeHtml(distTitle)}</div>
                            ${distDesc ? `<p style="font-size: 14px; color: #666; margin-top: 5px;">${escapeHtml(distDesc)}</p>` : ""}
                            ${
                                downloadURL
                                    ? `
                                <a href="${escapeHtml(downloadURL)}" target="_blank" class="download-link">
                                    ‚¨áÔ∏è Download ${escapeHtml(format)}
                                </a>
                            `
                                    : '<p style="color: #999; margin-top: 10px;">Geen download link beschikbaar</p>'
                            }
                        </div>
                    `;
                        })
                        .join("");
                }

                const html = `
                <h2 class="details-title">${escapeHtml(title)}</h2>
                <div class="details-id">Dataset ID: ${escapeHtml(dataset.id)}</div>

                <div class="meta-grid">
                    ${
                        publisher
                            ? `
                        <div class="meta-item">
                            <strong>üèõÔ∏è Uitgever</strong>
                            ${escapeHtml(publisher)}
                        </div>
                    `
                            : ""
                    }
                    ${
                        modified
                            ? `
                        <div class="meta-item">
                            <strong>üîÑ Laatst gewijzigd</strong>
                            ${new Date(modified).toLocaleDateString("nl-NL")}
                        </div>
                    `
                            : ""
                    }
                    ${
                        issued
                            ? `
                        <div class="meta-item">
                            <strong>üìÖ Gepubliceerd</strong>
                            ${new Date(issued).toLocaleDateString("nl-NL")}
                        </div>
                    `
                            : ""
                    }
                </div>

                <div class="section">
                    <h3>üìñ Beschrijving</h3>
                    <p>${escapeHtml(desc)}</p>
                </div>

                <div class="section">
                    <h3>‚¨áÔ∏è Downloads</h3>
                    ${downloadsHtml}
                </div>
                <div class="section woo-section">
                    <div class="woo-header">
                        <h3>üîó Woo Koppeling</h3>
                    </div>
                    <div id="wooAnalysis-${escapeHtml(dataset.id)}" class="woo-loading">
                        <button onclick="loadWooAnalysis('${escapeHtml(dataset.id)}')"
                                id="wooLoadBtn-${escapeHtml(dataset.id)}"
                                style="padding: 10px 20px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üîç Toon Woo-analyse
                        </button>
                    </div>
                </div>
            `;

                document.getElementById("modalContent").innerHTML = html;
            }

            // Cache voor Woo-analyses
            const wooCache = new Map();

            async function loadWooAnalysis(datasetId) {
                const container = document.getElementById(
                    `wooAnalysis-${datasetId}`,
                );
                const button = document.getElementById(
                    `wooLoadBtn-${datasetId}`,
                );

                // Verberg knop en toon loading
                if (button) button.style.display = "none";
                container.innerHTML =
                    '<div class="woo-loading">‚è≥ Woo-analyse laden...</div>';

                // Check cache
                if (wooCache.has(datasetId)) {
                    container.innerHTML = wooCache.get(datasetId);
                    return;
                }

                try {
                    const response = await fetch(`/woo/analyze/${datasetId}`);
                    const analysis = await response.json();

                    let html = "";

                    if (analysis.error) {
                        html = `<p style="color: #999;">‚ùå Fout bij Woo-analyse: ${escapeHtml(analysis.error)}</p>`;
                    } else {
                        // Topics
                        if (analysis.topics && analysis.topics.length > 0) {
                            html +=
                                '<div class="woo-topics"><strong>üìå Ge√Ødentificeerde onderwerpen:</strong><br>';
                            analysis.topics.forEach((topic) => {
                                html += `<span class="woo-topic-tag">${escapeHtml(topic)}</span>`;
                            });
                            html += "</div>";
                        }

                        // Categories
                        if (
                            analysis.categories &&
                            Object.keys(analysis.categories).length > 0
                        ) {
                            html +=
                                '<div class="woo-categories"><strong>‚úÖ Relevante Woo-categorie√´n:</strong>';
                            for (const [catId, catInfo] of Object.entries(
                                analysis.categories,
                            )) {
                                html += `
                                <div class="woo-category-item">
                                    <strong>[${escapeHtml(catId)}] ${escapeHtml(catInfo.name)}</strong><br>
                                    <span style="color: #666; font-size: 0.9em;">‚Üí ${escapeHtml(catInfo.reason)}</span>
                                </div>
                            `;
                            }
                            html += "</div>";
                        } else {
                            html +=
                                '<p style="color: #666; margin: 15px 0;">‚ÑπÔ∏è Geen directe Woo-categorie√´n ge√Ødentificeerd voor deze dataset.</p>';
                        }

                        // Link to Woo-index
                        html += `
                        <a href="https://organisaties.overheid.nl/woo/nl.oorg.gemutrecht_gemeente"
                           target="_blank"
                           class="woo-link">
                            üîç Bekijk Woo-documenten Utrecht
                        </a>
                    `;

                        // Keywords for search
                        if (analysis.keywords && analysis.keywords.length > 0) {
                            html += `
                            <p style="margin-top: 15px; font-size: 0.85em; color: #666;">
                                <strong>üí° Tip:</strong> Zoek op de Woo-index met termen als:
                                ${analysis.keywords
                                    .slice(0, 5)
                                    .map((k) => `"${escapeHtml(k)}"`)
                                    .join(", ")}
                            </p>
                        `;
                        }
                    }

                    // Sla op in cache
                    wooCache.set(datasetId, html);

                    container.innerHTML = html;
                } catch (error) {
                    const errorHtml = `<p style="color: #999;">‚ùå Kon Woo-analyse niet laden</p>`;
                    container.innerHTML = errorHtml;
                    console.error("Woo analysis error:", error);
                }
            }

            function closeModal() {
                document.getElementById("modal").classList.remove("show");
            }

            // Event listeners
            document
                .getElementById("searchInput")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter") search();
                });

            document.getElementById("modal").addEventListener("click", (e) => {
                if (e.target.id === "modal") closeModal();
            });

            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeModal();
            });

            // ===== DATA.OVERHEID.NL FUNCTIES =====

            async function searchOverheid() {
                const query = document.getElementById(
                    "overheidSearchInput",
                ).value;
                const org = document.getElementById("orgFilter").value;

                document.getElementById("status").textContent =
                    "Zoeken op data.overheid.nl...";
                document.getElementById("results").innerHTML = "";

                try {
                    let url = "/dataoverheid/package_search?rows=20";

                    if (query) {
                        url += `&q=${encodeURIComponent(query)}`;
                    } else {
                        url += "&q=*:*";
                    }

                    if (org) {
                        url += `&fq=organization:"${encodeURIComponent(org)}"`;
                    }

                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.success && data.result) {
                        const datasets = data.result.results || [];
                        const count = data.result.count || 0;

                        document.getElementById("status").textContent =
                            `Gevonden: ${count} datasets op data.overheid.nl`;

                        displayOverheidDatasets(datasets);
                    } else {
                        throw new Error("Geen resultaten");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    document.getElementById("status").textContent =
                        "‚ùå Fout bij ophalen data.overheid.nl datasets";
                    document.getElementById("results").innerHTML =
                        '<div class="loading">Kon data niet ophalen. Zorg dat de proxy server draait.</div>';
                }
            }

            function displayOverheidDatasets(datasets) {
                const resultsDiv = document.getElementById("results");

                if (datasets.length === 0) {
                    resultsDiv.innerHTML =
                        '<div class="loading">Geen datasets gevonden</div>';
                    return;
                }

                resultsDiv.innerHTML = datasets
                    .map((dataset) => {
                        const title = escapeHtml(
                            dataset.title || dataset.name || "Geen titel",
                        );
                        const notes = escapeHtml(
                            dataset.notes || "Geen beschrijving",
                        );
                        const preview =
                            notes.length > 200
                                ? notes.substring(0, 200) + "..."
                                : notes;
                        const org = dataset.organization || {};
                        const orgTitle = escapeHtml(
                            org.title || org.name || "Onbekend",
                        );

                        const resources = dataset.resources || [];
                        const formats = [
                            ...new Set(
                                resources.map((r) => r.format).filter((f) => f),
                            ),
                        ];
                        const formatText =
                            formats.length > 0
                                ? formats.slice(0, 3).join(", ")
                                : "Geen downloads";

                        return `
                        <div class="dataset-card" onclick='showOverheidDetails("${dataset.name}")'>
                            <div class="dataset-title">${title}</div>
                            <div class="dataset-org">üèõÔ∏è ${orgTitle}</div>
                            <div class="dataset-description">${preview}</div>
                            <div class="dataset-meta">
                                <span>üì¶ ${resources.length} resource(s)</span>
                                <span>üìÑ ${formatText}</span>
                            </div>
                        </div>
                    `;
                    })
                    .join("");
            }

            // Cache voor data.overheid.nl details
            const overheidCache = new Map();

            async function showOverheidDetails(datasetId) {
                document.getElementById("modal").style.display = "flex";
                document.getElementById("modalContent").innerHTML =
                    '<div class="loading">Details laden...</div>';

                try {
                    // Check cache
                    const cached = overheidCache.get(datasetId);
                    if (
                        cached &&
                        Date.now() - cached.timestamp < CACHE_DURATION
                    ) {
                        displayOverheidDetailsModal(cached.data);
                        return;
                    }

                    const response = await fetch(
                        `/dataoverheid/package_show?id=${encodeURIComponent(datasetId)}`,
                    );
                    const data = await response.json();

                    if (data.success && data.result) {
                        // Sla op in cache
                        overheidCache.set(datasetId, {
                            data: data.result,
                            timestamp: Date.now(),
                        });
                        displayOverheidDetailsModal(data.result);
                    } else {
                        throw new Error("Geen data");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    document.getElementById("modalContent").innerHTML =
                        '<div class="loading">‚ùå Fout bij ophalen details</div>';
                }
            }

            function displayOverheidDetailsModal(dataset) {
                const title = escapeHtml(
                    dataset.title || dataset.name || "Geen titel",
                );
                const notes = escapeHtml(dataset.notes || "Geen beschrijving");
                const org = dataset.organization || {};
                const orgTitle = escapeHtml(org.title || "Onbekend");
                const license = escapeHtml(dataset.license_title || "Onbekend");
                const created = dataset.metadata_created
                    ? dataset.metadata_created.substring(0, 10)
                    : "Onbekend";
                const modified = dataset.metadata_modified
                    ? dataset.metadata_modified.substring(0, 10)
                    : "Onbekend";

                let html = `
                    <div class="details-title">${title}</div>
                    <div class="details-id">ID: ${escapeHtml(dataset.name)}</div>

                    <div class="meta-grid">
                        <div class="meta-item">
                            <strong>üèõÔ∏è Organisatie</strong>
                            ${orgTitle}
                        </div>
                        <div class="meta-item">
                            <strong>üìú Licentie</strong>
                            ${license}
                        </div>
                        <div class="meta-item">
                            <strong>üìÖ Aangemaakt</strong>
                            ${created}
                        </div>
                        <div class="meta-item">
                            <strong>üîÑ Gewijzigd</strong>
                            ${modified}
                        </div>
                    </div>

                    <div class="section">
                        <h3>üìñ Beschrijving</h3>
                        <p>${notes.replace(/\n/g, "<br>")}</p>
                    </div>
                `;

                const tags = dataset.tags || [];
                if (tags.length > 0) {
                    html += '<div class="section"><h3>üè∑Ô∏è Tags</h3><p>';
                    tags.forEach((tag) => {
                        html += `<span class="woo-topic-tag">${escapeHtml(tag.display_name || tag.name)}</span> `;
                    });
                    html += "</p></div>";
                }

                const resources = dataset.resources || [];
                if (resources.length > 0) {
                    html += '<div class="section"><h3>üì¶ Downloads</h3>';

                    resources.forEach((resource) => {
                        const resName = escapeHtml(resource.name || "Naamloos");
                        const resFormat = escapeHtml(
                            resource.format || "Onbekend",
                        ).toUpperCase();
                        const resUrl = resource.url || "";

                        html += `
                            <div class="download-item">
                                <div class="download-header">
                                    <div class="download-format">${resFormat}</div>
                                </div>
                                <div class="download-title">${resName}</div>
                                ${resUrl ? `<a href="${escapeHtml(resUrl)}" class="download-link" target="_blank" onclick="event.stopPropagation()">‚¨áÔ∏è Download</a>` : ""}
                            </div>
                        `;
                    });

                    html += "</div>";
                }

                html += `
                    <div class="section">
                        <a href="https://data.overheid.nl/dataset/${escapeHtml(dataset.name)}"
                           target="_blank"
                           class="download-link"
                           onclick="event.stopPropagation()">
                            üîó Bekijk op data.overheid.nl
                        </a>
                    </div>
                `;

                document.getElementById("modalContent").innerHTML = html;
            }

            async function loadOrganizations() {
                try {
                    const response = await fetch(
                        "/dataoverheid/organization_list?all_fields=true",
                    );
                    const data = await response.json();

                    if (data.success && data.result) {
                        const orgs = data.result;

                        const select = document.getElementById("orgFilter");
                        select.innerHTML =
                            '<option value="">Alle organisaties</option>';
                        orgs.forEach((org) => {
                            const title =
                                org.title || org.display_name || org.name;
                            select.innerHTML += `<option value="${org.name}">${escapeHtml(title)} (${org.package_count || 0})</option>`;
                        });

                        document.getElementById("status").textContent =
                            `${orgs.length} overheidsorganisaties beschikbaar`;

                        const resultsDiv = document.getElementById("results");
                        resultsDiv.innerHTML = orgs
                            .slice(0, 50)
                            .map((org) => {
                                const title = escapeHtml(
                                    org.title || org.display_name || org.name,
                                );
                                const count = org.package_count || 0;
                                const desc = org.description
                                    ? escapeHtml(
                                          org.description.substring(0, 150),
                                      )
                                    : "";

                                return `
                                <div class="dataset-card" onclick='filterByOrg("${org.name}")' style="cursor: pointer;">
                                    <div class="dataset-title">üèõÔ∏è ${title}</div>
                                    <div class="dataset-meta">
                                        <span>üìä ${count} datasets</span>
                                    </div>
                                    ${desc ? `<div class="dataset-description">${desc}...</div>` : ""}
                                </div>
                            `;
                            })
                            .join("");

                        if (orgs.length > 50) {
                            resultsDiv.innerHTML += `<div class="loading">... en nog ${orgs.length - 50} organisaties meer. Gebruik de dropdown om te filteren.</div>`;
                        }
                    }
                } catch (error) {
                    console.error("Error:", error);
                }
            }

            function filterByOrg(orgName) {
                document.getElementById("orgFilter").value = orgName;
                document.getElementById("overheidSearchInput").value = "";
                searchOverheid();
            }

            document
                .getElementById("overheidSearchInput")
                .addEventListener("keypress", function (e) {
                    if (e.key === "Enter") {
                        searchOverheid();
                    }
                });

            // Auto-load
            loadAll();
        </script>
    </body>
</html>
